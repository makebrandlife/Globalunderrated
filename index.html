<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hidden Gems Travel — Full Experience (PWA + Share + LLM hooks)</title>
<meta name="description" content="Discover underrated travel destinations, generate AI-style itineraries, save bucket list items, view interactive maps and export itineraries to PDF. PWA-enabled, shareable, and LLM-ready." />
<meta property="og:title" content="Hidden Gems Travel — Full Experience" />
<meta property="og:description" content="Generate personalized itineraries, save bucket list items, view interactive maps and export itineraries to PDF." />
<meta property="og:image" content="https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=1200&q=80" />
<meta name="twitter:card" content="summary_large_image" />
<link rel="preconnect" href="https://images.unsplash.com" crossorigin>
<link rel="preconnect" href="https://picsum.photos" crossorigin>

<style>
  :root{--card:#fff;--accent:#2a9d8f;--muted:#6b7280}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#f6f7fb;color:#0b1220;line-height:1.4}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,.06);display:flex;gap:12px;align-items:center}
  .card-media{width:120px;height:80px;overflow:hidden;border-radius:8px;flex:0 0 120px}
  .card-media img{width:100%;height:100%;object-fit:cover;display:block}
  .card-body h3{margin:0;font-size:1rem}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:focus{outline:3px solid rgba(42,157,143,.18)}
  .muted{color:var(--muted);font-size:.95rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
  .modal.open{display:flex}
  .modal-panel{width:100%;max-width:820px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 20px 50px rgba(2,6,23,.2);max-height:90vh;overflow:auto}
  label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
  input[type=date],select,input[type=number],textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
  .row{display:flex;gap:8px}
  .row>div{flex:1}
  .itinerary{margin-top:12px}
  .it-day{background:#f8fafb;padding:10px;border-radius:8px;margin-bottom:8px}
  #miniMap{height:220px;border-radius:8px;margin-top:8px}
  #bucketModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999}
  #bucketModal.open{display:flex}
  #bucketModal .panel{background:#fff;padding:20px;border-radius:12px;max-width:640px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
  #bucketListGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
  .bucket-item{position:relative;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
  .bucket-item img{width:100%;height:90px;object-fit:cover;display:block}
  .bucket-remove{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:20px;text-align:center}
  .small{font-size:.85rem;color:var(--muted)}
  footer{margin-top:16px;font-size:.85rem;color:var(--muted)}
</style>
</head>
<body>
  <h1 style="font-size:1.25rem;margin:0 0 12px 0">Hidden Gems — Demo destination (PWA + Share + LLM hooks)</h1>

  <div class="card" id="demoCard">
    <div class="card-media">
      <img
        src="https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=800&q=60"
        srcset="https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=400&q=60 400w,
                https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=800&q=60 800w,
                https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=1200&q=60 1200w"
        sizes="(max-width:480px) 120px, 160px"
        alt="Faroe Islands"
        loading="lazy"
        width="320"
        height="240"
      >
    </div>
    <div class="card-body">
      <h3 id="demoTitle">Faroe Islands, Denmark</h3>
      <p id="demoDesc" class="muted" style="margin:.25rem 0">Dramatic cliffs, seabirds and Nordic solitude.</p>
      <div class="controls">
        <button class="btn" id="planBtn" aria-haspopup="dialog" aria-controls="plannerModal">Plan a Trip Here</button>
        <button class="btn" id="saveDemoBtn" style="background:#2b6cb0">Save to Bucket List</button>
        <button id="viewBucketBtn" style="margin-left:auto;background:#111827;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer">View My Bucket List</button>
      </div>
    </div>
  </div>

  <!-- Planner Modal -->
  <div class="modal" id="plannerModal" role="dialog" aria-modal="true" aria-labelledby="plannerTitle">
    <div class="modal-panel" role="document">
      <h2 id="plannerTitle" style="margin-top:0">AI Trip Planner — <span id="plDest">Faroe Islands</span></h2>
      <div class="row" style="margin-bottom:8px">
        <div class="field">
          <label for="startDate">Start date</label>
          <input type="date" id="startDate" aria-label="Start date">
        </div>
        <div class="field">
          <label for="duration">Duration (days)</label>
          <select id="duration" aria-label="Duration"><option value="3">3</option><option value="5" selected>5</option><option value="7">7</option><option value="10">10</option></select>
        </div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <div class="field"><label for="budgetLevel">Budget</label>
          <select id="budgetLevel"><option value="low">Budget</option><option value="mid" selected>Mid-range</option><option value="luxury">Luxury</option></select>
        </div>
        <div class="field"><label for="travelerType">Traveler type</label>
          <select id="travelerType"><option value="solo">Solo</option><option value="couple" selected>Couple</option><option value="family">Family</option></select>
        </div>
      </div>
      <div class="field"><label for="notes">Notes</label><textarea id="notes" rows="2" placeholder="e.g. hiking, whales, photography" aria-label="Notes"></textarea></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px">
        <button id="closePlanner">Cancel</button>
        <!-- Generate (LLM) tries serverless LLM endpoint if configured; else local fallback -->
        <button class="btn" id="generateLLMBtn">Generate (LLM)</button>
        <button class="btn" id="generateBtn" title="Local generator fallback">Generate (Local)</button>
      </div>

      <div id="itineraryArea" class="itinerary" aria-live="polite"></div>
      <div id="miniMap" aria-hidden="true"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="downloadPdf" class="btn" style="display:none">Download PDF</button>
        <button id="savePlan" class="btn" style="background:#2b6cb0;display:none">Save Plan</button>
        <button id="sharePlanBtn" style="display:none;border-radius:8px;padding:8px 12px;background:#0ea5a4;color:#fff;border:none;cursor:pointer">Share</button>
      </div>

      <div style="margin-top:10px" class="small">
        <strong>LLM endpoint:</strong> <span id="llmInfo">Not configured</span>
      </div>
    </div>
  </div>

  <!-- Bucket Preview Modal -->
  <div id="bucketModal" aria-hidden="true">
    <div class="panel">
      <h2 style="margin-top:0">My Bucket List</h2>
      <div id="bucketListGrid"></div>
      <div style="text-align:right;margin-top:10px">
        <button onclick="closeBucketModal()">Close</button>
        <button onclick="exportBucketAsHTML()" style="background:#2a9d8f;color:#fff;border:none;border-radius:8px;padding:6px 12px;cursor:pointer">Export as HTML</button>
      </div>
    </div>
  </div>

  <footer>
    Tip: install as a PWA for offline usage. To enable server-side (LLM) itineraries, deploy the provided serverless function and set the LLM endpoint below in the config section of the script.
  </footer>

<script>
/* =========================
   Configuration (edit these)
   =========================
   - To enable real LLM itineraries, deploy the serverless function (example included below) and set LLM_ENDPOINT to its URL.
   - For production, ensure the serverless function validates and stores your API key securely; never place secret keys in client HTML.
*/
const CONFIG = {
  // Example: "https://your-deploy.netlify.app/.netlify/functions/itinerary" or "https://your-vercel.app/api/itinerary"
  LLM_ENDPOINT: "",

  // Optional: when you host an OG generator service, set OG_ENDPOINT
  OG_ENDPOINT: "" // leave blank unless you implement server-side OG image generation
};

/* update UI for LLM status */
document.addEventListener('DOMContentLoaded', ()=> {
  document.getElementById('llmInfo').textContent = CONFIG.LLM_ENDPOINT ? CONFIG.LLM_ENDPOINT : 'Not configured';
});

/* =========================
   Progressive manifest + service worker registration
   We generate a manifest blob and register SW from within this single-file app.
   ========================= */
async function registerPWA(){
  // create a manifest blob so we can keep this single-file
  const manifest = {
    name: "Hidden Gems Travel",
    short_name: "HiddenGems",
    start_url: ".",
    display: "standalone",
    background_color: "#f6f7fb",
    theme_color: "#2a9d8f",
    icons: [
      { src: "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='#2a9d8f'/><text x='50%' y='50%' font-size='72' fill='#fff' font-family='Arial, sans-serif' text-anchor='middle' alignment-baseline='central'>HG</text></svg>`), sizes: "192x192", type: "image/svg+xml" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const manifestURL = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestURL;
  document.head.appendChild(link);

  // Register service worker (we create it dynamically so file remains single-file)
  if('serviceWorker' in navigator){
    try {
      const swCode = `
        const CACHE_NAME = 'hg-cache-v1';
        const PRECACHE = [
          './',
          location.pathname, // allow file-based hosting
          // common external resources we might want to cache first time
        ];
        self.addEventListener('install', event => {
          self.skipWaiting();
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(PRECACHE).catch(()=>{}))
          );
        });
        self.addEventListener('activate', event => {
          event.waitUntil(self.clients.claim());
        });
        self.addEventListener('fetch', event => {
          // network-first for API calls (so LLM works when available), cache-first for static
          const url = new URL(event.request.url);
          if (url.pathname.includes('/.netlify/functions') || url.pathname.includes('/api/')) {
            event.respondWith(fetch(event.request).catch(()=>caches.match(event.request)));
            return;
          }
          event.respondWith(
            caches.match(event.request).then(resp => resp || fetch(event.request).then(r => {
              // cache some GET responses
              try {
                if (event.request.method === 'GET' && r && r.type!=='opaque') {
                  const clone = r.clone();
                  caches.open(CACHE_NAME).then(c => c.put(event.request, clone)).catch(()=>{});
                }
              } catch(e){}
              return r;
            }).catch(()=>caches.match('./')))
          );
        });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(swBlob);
      await navigator.serviceWorker.register(swURL);
      // console.log('Service worker registered');
    } catch(e){
      console.warn('SW registration failed', e);
    }
  }
}
registerPWA();

/* =========================
   Utility: load CSS/JS dynamically
   ========================= */
function loadCss(href){ return new Promise((res,rej)=>{ if(document.querySelector(`link[href="${href}"]`))return res(); const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); }); }
function loadScript(src){ return new Promise((res,rej)=>{ if(document.querySelector(`script[data-src="${src}"]`))return res(); const s=document.createElement('script'); s.src=src; s.async=false; s.setAttribute('data-src', src); s.onload=res; s.onerror=rej; document.body.appendChild(s); }); }

/* =========================
   App state + DOM refs
   ========================= */
const demo = { id:1, name:document.getElementById('demoTitle').textContent, desc:document.getElementById('demoDesc').textContent, lat:62.0, lng:-6.8 };
const modal = document.getElementById('plannerModal');
const planBtn = document.getElementById('planBtn');
const closePlanner = document.getElementById('closePlanner');
const generateBtn = document.getElementById('generateBtn');
const generateLLMBtn = document.getElementById('generateLLMBtn');
const itineraryArea = document.getElementById('itineraryArea');
const plDest = document.getElementById('plDest');
const downloadPdfBtn = document.getElementById('downloadPdf');
const savePlanBtn = document.getElementById('savePlan');
const sharePlanBtn = document.getElementById('sharePlanBtn');
const viewBucketBtn = document.getElementById('viewBucketBtn');
let leafletLoaded=false, miniMap, routeLayer;
let jsPDFLoaded=false;
let lastActive=null;

/* =========================
   Lazy load map and jsPDF when needed
   ========================= */
async function initLeafletOnce(){
  if(leafletLoaded) return;
  leafletLoaded=true;
  try {
    await loadCss('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
    await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
    miniMap = L.map('miniMap',{zoomControl:false,attributionControl:false}).setView([demo.lat,demo.lng],9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
    routeLayer = L.layerGroup().addTo(miniMap);
    document.getElementById('miniMap').setAttribute('aria-hidden','false');
  } catch(e){ console.warn('Leaflet load failed', e); }
}
async function ensureJsPDF(){ if(jsPDFLoaded) return; try{ await loadScript('https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'); jsPDFLoaded = true; } catch(e){ console.warn('jsPDF failed', e); } }

/* =========================
   Modal open/close and focus
   ========================= */
function ensureStartDate(){ const s=document.getElementById('startDate'); if(!s.value){ const d=new Date(); d.setDate(d.getDate()+7); s.value=d.toISOString().slice(0,10);} }
function openPlannerModal(){ plDest.textContent = demo.name.split(',')[0]; modal.classList.add('open'); ensureStartDate(); initLeafletOnce().then(()=> miniMap && setTimeout(()=>miniMap.invalidateSize(),120)); lastActive=document.activeElement; document.addEventListener('keydown', handleEscape, {capture:true}); }
function closePlannerModal(){ modal.classList.remove('open'); itineraryArea.innerHTML=''; downloadPdfBtn.style.display='none'; savePlanBtn.style.display='none'; sharePlanBtn.style.display='none'; if(routeLayer && routeLayer.clearLayers) routeLayer.clearLayers(); document.removeEventListener('keydown', handleEscape, {capture:true}); lastActive && lastActive.focus && lastActive.focus(); }
function handleEscape(e){ if(e.key==='Escape') closePlannerModal(); }

planBtn.addEventListener('click', openPlannerModal);
closePlanner.addEventListener('click', closePlannerModal);

/* =========================
   Itinerary generation
   - try LLM first if endpoint provided, then fallback to local generator
   - serverless LLM contract: POST { dest, start, days, budget, traveler, notes } -> returns { plan:[{day,date,items:[{time,activity}]}], estimate:number }
   ========================= */
async function generateItineraryLocal({start, days, budget, traveler, notes}){
  const keywords = (demo.desc + ' ' + (notes||'')).toLowerCase();
  const activities = [];
  if(keywords.includes('hike')||keywords.includes('cliff')) activities.push('Hike a scenic trail');
  if(keywords.includes('whale')) activities.push('Whale watching tour');
  if(keywords.includes('fjord')) activities.push('Boat cruise of the fjords');
  if(keywords.includes('monastery')) activities.push('Cultural village visit');
  if(activities.length === 0) activities.push('Local highlights and photo spots');
  const plan = [];
  for(let d=0; d<days; d++){
    const date = new Date(start); date.setDate(date.getDate()+d);
    const day = { day: d+1, date: date.toISOString().slice(0,10), items: [] };
    day.items.push({ time:'Morning', activity: activities[d % activities.length] });
    day.items.push({ time:'Afternoon', activity: 'Explore local town' });
    if(traveler === 'couple') day.items.push({ time:'Evening', activity:'Cozy dinner' });
    else if(traveler === 'solo') day.items.push({ time:'Evening', activity:'Photography walk' });
    else day.items.push({ time:'Evening', activity:'Family dinner' });
    plan.push(day);
  }
  const base = (budget === 'low') ? 60 : (budget === 'mid') ? 120 : 260;
  const estimate = base * days;
  return { plan, estimate };
}

async function callLLMServer(payload){
  if(!CONFIG.LLM_ENDPOINT) throw new Error('LLM endpoint not configured');
  const res = await fetch(CONFIG.LLM_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('LLM server error');
  return res.json(); // expects { plan, estimate }
}

async function handleGenerate({useLLM=false}){
  const start = document.getElementById('startDate').value;
  const days = parseInt(document.getElementById('duration').value,10);
  const budget = document.getElementById('budgetLevel').value;
  const traveler = document.getElementById('travelerType').value;
  const notes = document.getElementById('notes').value;
  if(!start){ alert('Please pick a start date'); return; }
  itineraryArea.innerHTML = '<p class="small">Generating itinerary…</p>';
  let result;
  if(useLLM && CONFIG.LLM_ENDPOINT){
    try {
      result = await callLLMServer({ dest: demo, start, days, budget, traveler, notes });
    } catch(e){
      console.warn('LLM failed, falling back to local generator', e);
      result = await generateItineraryLocal({ start, days, budget, traveler, notes });
    }
  } else {
    result = await generateItineraryLocal({ start, days, budget, traveler, notes });
  }

  renderPlanAndMap(result, { dest: demo, start, days, budget, traveler, notes });
}

generateLLMBtn.addEventListener('click', ()=>handleGenerate({useLLM:true}));
generateBtn.addEventListener('click', ()=>handleGenerate({useLLM:false}));

function renderPlanAndMap(result, meta){
  // draw map route (demo)
  const routeCoords = [];
  for(let i=0;i<6;i++){ const angle=(i/6)*Math.PI*2; const r=0.2; routeCoords.push([demo.lat+Math.sin(angle)*r, demo.lng+Math.cos(angle)*r]); }
  if(routeLayer && L && L.polyline){
    routeLayer.clearLayers();
    L.polyline(routeCoords,{color:'#e76f51'}).addTo(routeLayer);
    routeLayer.addLayer(L.circleMarker([demo.lat,demo.lng],{radius:6,fillColor:'#2a9d8f',color:'#fff',weight:2}).bindPopup(demo.name));
    try { miniMap.fitBounds(L.latLngBounds(routeCoords).pad(0.5)); } catch(e){}
  }
  itineraryArea.innerHTML = `<h3 style="margin:.25rem 0">Estimated cost: <strong>USD ${result.estimate.toFixed(0)}</strong></h3>` +
    result.plan.map(d=>`<div class="it-day" tabindex="0"><strong>Day ${d.day} — ${d.date}</strong><ul>${d.items.map(i=>`<li><em>${i.time}</em>: ${i.activity}</li>`).join('')}</ul></div>`).join('');
  // store last generated plan in window
  window._lastGeneratedPlan = { meta, plan: result.plan, estimate: result.estimate };
  downloadPdfBtn.style.display='inline-block';
  savePlanBtn.style.display='inline-block';
  sharePlanBtn.style.display='inline-block';
  // inject JSON-LD for this specific generated plan (useful for debugging / preview)
  injectJSONLDForPlan(window._lastGeneratedPlan);
}

/* =========================
   Save / Share / Export
   - Save to localStorage
   - Shareable URL: ?plan=<base64url> which reconstructs everything on load
   - Export HTML snapshot (for hosting somewhere that produces OG images)
   ========================= */
function savePlanToLocal(){
  const data = window._lastGeneratedPlan;
  if(!data){ alert('No plan to save'); return; }
  const saved = JSON.parse(localStorage.getItem('hg_saved_plans') || '[]');
  saved.push({ id: Date.now(), created: new Date().toISOString(), data });
  localStorage.setItem('hg_saved_plans', JSON.stringify(saved));
  alert('Plan saved locally.');
}
function makeShareURLForPlan(){
  const p = window._lastGeneratedPlan;
  if(!p){ alert('No plan to share'); return; }
  // encode as base64url (compact)
  const str = JSON.stringify(p);
  const b64 = btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  // Use query parameter so it works when the file is opened directly
  const url = `${location.origin}${location.pathname}?plan=${b64}`;
  return url;
}
function copyToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
  return new Promise((res,rej)=>{ try{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); res(); }catch(e){ rej(e); } });
}

async function sharePlan(){
  const url = makeShareURLForPlan();
  if(navigator.share){
    try { await navigator.share({ title: 'My trip plan', text: `${window._lastGeneratedPlan.meta.dest.name} — ${window._lastGeneratedPlan.meta.start}`, url }); return; } catch(e){ /* user cancelled or not supported */ }
  }
  await copyToClipboard(url);
  alert('Share URL copied to clipboard:\n' + url + '\n\n(You can paste it into chat or email.)');
}
savePlanBtn.addEventListener('click', savePlanToLocal);
sharePlanBtn.addEventListener('click', sharePlan);

/* When saving a plan, also create an embedded JSON-LD script for the plan and store it in localStorage for export if needed */
function injectJSONLDForPlan(saved){
  // Remove old if exists
  const existing = document.getElementById('plan-jsonld');
  if(existing) existing.remove();
  const ld = {
    "@context":"https://schema.org",
    "@type":"TouristTrip",
    "name": `${saved.meta.dest.name} — ${saved.meta.start} (${saved.meta.days} days)`,
    "description": saved.meta.dest.desc || '',
    "touristType": saved.meta.traveler,
    "totalTime": `P${saved.meta.days}D`,
    "estimatedCost": {
      "@type":"MonetaryAmount",
      "currency":"USD",
      "value": saved.estimate || saved.meta.estimate
    },
    "itinerary": saved.plan.map(d=>({
      "@type":"TouristAttraction",
      "name": `Day ${d.day}`,
      "description": d.items.map(i=>`${i.time}: ${i.activity}`).join(' — '),
      "startDate": d.date
    }))
  };
  const s = document.createElement('script');
  s.type = 'application/ld+json';
  s.id = 'plan-jsonld';
  s.textContent = JSON.stringify(ld, null, 2);
  document.head.appendChild(s);
}

/* Generate a downloadable HTML snapshot containing the plan (useful if you want to host a static file that yields an OG preview) */
function generateHTMLSnapshotForPlan(){
  const p = window._lastGeneratedPlan;
  if(!p){ alert('No plan to snapshot'); return null; }
  // simple HTML with JSON-LD and some metadata — host this in a server to produce OG images
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${p.meta.dest.name} — Itinerary</title>
  <meta property="og:title" content="${p.meta.dest.name} — Itinerary">
  <meta property="og:description" content="${p.meta.dest.desc}">
  <meta property="og:image" content="https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=1200&q=80">
  <script type="application/ld+json">${document.getElementById('plan-jsonld').textContent}</script>
  </head><body><h1>${p.meta.dest.name} — ${p.meta.start}</h1><pre>${JSON.stringify(p, null, 2)}</pre></body></html>`;
  return html;
}
function exportBucketAsHTML(){
  // build simple HTML of bucket items (download client-side)
  const list = JSON.parse(localStorage.getItem('hg_favs') || '[]');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>My Bucket List</title></head><body><h1>Bucket List</h1><ul>${list.map(i=>`<li>Item ${i}</li>`).join('')}</ul></body></html>`;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'bucket_list.html'; document.body.appendChild(a); a.click(); a.remove();
}

/* Provide a downloadable snapshot for share (user can host this) */
function downloadSnapshot(){
  const snap = generateHTMLSnapshotForPlan();
  if(!snap) return;
  const blob = new Blob([snap], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'itinerary_snapshot.html'; document.body.appendChild(a); a.click(); a.remove();
}

/* =========================
   PDF export (deferred)
   ========================= */
downloadPdfBtn.addEventListener('click', async ()=>{
  const last = window._lastGeneratedPlan;
  if(!last){ alert('No plan'); return; }
  await ensureJsPDF();
  if(!jsPDFLoaded){ alert('Failed to load PDF library'); return; }
  const doc = new jspdf.jsPDF({ unit:'pt', format:'a4' });
  const title = `${last.meta.dest.name} — ${last.meta.start} (${last.meta.days} days)`;
  doc.setFontSize(14); doc.text(title, 40, 50);
  doc.setFontSize(10); doc.text(`Estimated cost: USD ${last.estimate.toFixed(0)}`, 40, 70);
  let y = 100;
  last.plan.forEach(day=>{
    doc.setFontSize(11); doc.text(`Day ${day.day} — ${day.date}`, 40, y); y += 16;
    day.items.forEach(it=>{
      doc.setFontSize(10); doc.text(`${it.time}: ${it.activity}`, 60, y); y+=14;
      if(y > 740){ doc.addPage(); y = 40; }
    });
    y += 8;
  });
  const filename = `${last.meta.dest.name.replace(/[^a-z0-9]/gi,'_')}_itinerary.pdf`;
  doc.save(filename);
});

/* =========================
   Bucket modal functions
   ========================= */
function openBucketModal(){
  const list = JSON.parse(localStorage.getItem('hg_favs') || '[]');
  const grid = document.getElementById('bucketListGrid'); grid.innerHTML='';
  if(list.length === 0) grid.innerHTML='<p>Your bucket list is empty.</p>'; else {
    list.forEach(id=>{
      const div = document.createElement('div'); div.className='bucket-item';
      div.innerHTML = `<img src="https://picsum.photos/seed/${id}/200/120" loading="lazy" alt="bucket item ${id}"><button class="bucket-remove" onclick="removeFromBucket(${id})" aria-label="Remove">×</button>`;
      grid.appendChild(div);
    });
  }
  document.getElementById('bucketModal').classList.add('open');
}
function closeBucketModal(){ document.getElementById('bucketModal').classList.remove('open'); }
function removeFromBucket(id){ let list=JSON.parse(localStorage.getItem('hg_favs')||'[]'); list=list.filter(x=>x!==id); localStorage.setItem('hg_favs', JSON.stringify(list)); openBucketModal(); }

document.getElementById('saveDemoBtn').addEventListener('click', ()=>{
  const favs = JSON.parse(localStorage.getItem('hg_favs') || '[]'); if(!favs.includes(demo.id)) favs.push(demo.id); localStorage.setItem('hg_favs', JSON.stringify(favs)); alert('Saved to favorites'); });
viewBucketBtn.addEventListener('click', openBucketModal);

/* expose helpers globally used by inline HTML */
window.closeBucketModal = closeBucketModal;
window.renderBucketList = ()=>{ alert('Share/export via Export as HTML or Save+Share Snapshot'); };
window.removeFromBucket = removeFromBucket;

/* =========================
   Handle share load: if ?plan=<base64> present, reconstruct
   ========================= */
function decodePlanFromQuery(){
  const params = new URLSearchParams(location.search);
  const b64 = params.get('plan');
  if(!b64) return null;
  try {
    const padded = b64.replace(/-/g,'+').replace(/_/g,'/'); // base64url -> base64
    const json = decodeURIComponent(escape(atob(padded)));
    return JSON.parse(json);
  } catch(e){ console.warn('Failed to decode plan', e); return null; }
}
async function restoreSharedPlanIfAny(){
  const shared = decodePlanFromQuery();
  if(!shared) return;
  // open modal and render
  openPlannerModal();
  // inject into window._lastGeneratedPlan
  window._lastGeneratedPlan = shared;
  injectJSONLDForPlan(shared);
  // render plan UI
  itineraryArea.innerHTML = `<h3 style="margin:.25rem 0">Estimated cost: <strong>USD ${shared.estimate.toFixed(0)}</strong></h3>` +
    shared.plan.map(d=>`<div class="it-day" tabindex="0"><strong>Day ${d.day} — ${d.date}</strong><ul>${d.items.map(i=>`<li><em>${i.time}</em>: ${i.activity}</li>`).join('')}</ul></div>`).join('');
  downloadPdfBtn.style.display='inline-block'; savePlanBtn.style.display='inline-block'; sharePlanBtn.style.display='inline-block';
  // map init
  await initLeafletOnce();
  if(routeLayer && L){
    // draw a demo route
    const routeCoords=[]; for(let i=0;i<6;i++){const angle=(i/6)*Math.PI*2;const r=0.2;routeCoords.push([demo.lat+Math.sin(angle)*r,demo.lng+Math.cos(angle)*r]);}
    routeLayer.clearLayers(); L.polyline(routeCoords,{color:'#e76f51'}).addTo(routeLayer); routeLayer.addLayer(L.circleMarker([demo.lat,demo.lng],{radius:6,fillColor:'#2a9d8f',color:'#fff',weight:2}).bindPopup(demo.name)); try{ miniMap.fitBounds(L.latLngBounds(routeCoords).pad(0.5)); }catch(e){}
  }
}
restoreSharedPlanIfAny();

/* =========================
   Small accessibility focus trapping (lightweight)
   ========================= */
document.addEventListener('focusin', (e) => {
  const modalEl = document.getElementById('plannerModal');
  if(!modalEl.classList.contains('open')) return;
  const panel = modalEl.querySelector('.modal-panel');
  if(!panel.contains(e.target)) { e.stopPropagation(); panel.focus(); }
});

/* Close modals when clicking outside */
document.getElementById('bucketModal').addEventListener('click', (e)=>{ if(e.target.id==='bucketModal') closeBucketModal(); });
document.getElementById('plannerModal').addEventListener('click', (e)=>{ if(e.target.id==='plannerModal') closePlannerModal(); });

/* =========================
   OPTIONAL: Serverless function example for Vercel / Netlify
   - Deploy this serverless function and set CONFIG.LLM_ENDPOINT to its URL.
   - Important: keep your real LLM / OpenAI API key on the server only.
   =========================
   Example (Node) for Vercel / Netlify (save as api/itinerary.js or functions/itinerary.js):

   // ------------------ example serverless (Node) ------------------
   // Vercel / Netlify style single function
   const fetch = require('node-fetch'); // Node 18 has fetch built-in; include if needed

   module.exports = async (req, res) => {
     try {
       const body = req.body || JSON.parse(req);
       const { dest, start, days, budget, traveler, notes } = body;
       // validate input
       if(!start || !days) return res.status(400).json({ error: 'invalid' });

       // Build prompt for LLM (example for OpenAI)
       const prompt = `Create a ${days}-day itinerary for ${dest.name} starting ${start}. Budget: ${budget}. Traveler: ${traveler}. Interests: ${notes}. Provide JSON: { plan:[{day,date,items:[{time,activity}]}], estimate:number }`;

       // call OpenAI (server must keep API key secret)
       const r = await fetch('https://api.openai.com/v1/chat/completions', {
         method:'POST',
         headers:{
           'Content-Type':'application/json',
           'Authorization':'Bearer ' + process.env.OPENAI_API_KEY
         },
         body: JSON.stringify({
           model: 'gpt-4o-mini', // or gpt-4o or whichever
           messages: [{ role:'user', content: prompt }],
           temperature:0.7,
           max_tokens:800
         })
       });
       const j = await r.json();
       // parse assistant reply to JSON safely (the server can use a JSON parser or regex)
       // For safety, you should direct the LLM to return strict JSON, then parse it.
       // Here we assume the response has JSON in j.choices[0].message.content
       const content = j.choices?.[0]?.message?.content || '{}';
       // Attempt to find JSON substring
       const match = content.match(/\{[\\s\\S]*\}$/);
       const parsed = match ? JSON.parse(match[0]) : { plan:[], estimate:0 };
       res.json(parsed);
     } catch(err){
       console.error(err);
       res.status(500).json({ error: 'server error' });
     }
   };
   // ------------------ end serverless example ------------------

   Notes:
   - Deploy this on Vercel/Netlify and set your OPENAI_API_KEY in environment variables.
   - Validate and sanitize inputs.
   - Rate-limit and require authentication in production.
*/

/* =========================
   Last: on page load, pre-warm jsPDF in background (non-blocking)
   ========================= */
window.addEventListener('load', ()=>{ setTimeout(()=>ensureJsPDF(), 3000); });

</script>
</body>
</html>
